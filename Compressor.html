<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compressor Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+Khmer:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- JSZip for creating .zip archives -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- pdf-lib for PDF manipulation -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

    <style>
        :root {
            --bg-color: #F8FAFC; /* slate-50 */
            --card-bg: #FFFFFF;
            --text-primary: #1E293B; /* slate-800 */
            --text-secondary: #475569; /* slate-600 */
            --text-muted: #94A3B8; /* slate-400 */
            --border-color: #E2E8F0; /* slate-200 */
            --accent-color: #4F46E5; /* indigo-600 */
            --accent-hover: #4338CA; /* indigo-700 */
            --success-color: #16A34A; /* green-600 */
            --error-color: #DC2626; /* red-600 */
            --card-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        html.dark {
            --bg-color: #0F172A; /* slate-900 */
            --card-bg: #1E293B; /* slate-800 */
            --text-primary: #F1F5F9; /* slate-100 */
            --text-secondary: #94A3B8; /* slate-400 */
            --text-muted: #64748B; /* slate-500 */
            --border-color: #334155; /* slate-700 */
            --card-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.2), 0 2px 4px -2px rgb(0 0 0 / 0.2);
        }

        body { 
            font-family: 'Inter', 'Noto Sans Khmer', sans-serif; 
            background-color: var(--bg-color);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        .font-khmer { font-family: 'Noto Sans Khmer', sans-serif; }

        /* Main Layout */
        .page-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem;
            min-height: 100vh;
        }
        .content-wrapper {
            width: 100%;
            max-width: 640px;
        }

        /* Back Button & Header */
        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            background: var(--card-bg);
            color: var(--text-secondary);
            font-weight: 600;
            border: 1px solid var(--border-color);
            text-decoration: none;
            transition: all 0.2s;
            box-shadow: var(--card-shadow);
        }
        .back-btn:hover {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }
        
        .main-card {
            background: var(--card-bg);
            border-radius: 1.25rem;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border-color);
            padding: 2rem;
            margin-top: 1rem;
            transition: all 0.3s;
        }

        /* Header Controls (Lang/Theme) */
        .header-controls { display: flex; align-items: center; gap: 0.75rem; }
        .theme-toggle-btn {
            background-color: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            width: 42px; height: 42px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s;
        }
        .theme-toggle-btn:hover { background-color: var(--accent-color); color: white; }
        .theme-toggle-btn .sun-icon, html.dark .theme-toggle-btn .moon-icon { display: block; }
        .theme-toggle-btn .moon-icon, html.dark .theme-toggle-btn .sun-icon { display: none; }

        .language-selector { position: relative; }
        .language-btn { background-color: var(--card-bg); color: var(--text-secondary); border: 1px solid var(--border-color); border-radius: 24px; padding: 8px 16px 8px 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s; }
        .language-btn:hover { background-color: var(--accent-color); color: white; border-color: var(--accent-color); }
        .language-btn .arrow { transition: transform 0.2s; }
        .language-selector.open .arrow { transform: rotate(180deg); }
        .dropdown-content { display: none; position: absolute; right: 0; background-color: var(--card-bg); min-width: 160px; border-radius: 14px; box-shadow: var(--card-shadow); z-index: 10; margin-top: 8px; overflow: hidden; border: 1px solid var(--border-color); }
        .language-selector.open .dropdown-content { display: block; }
        .language-option { color: var(--text-secondary); padding: 10px 16px; display: flex; align-items: center; gap: 10px; background: none; border: none; width: 100%; text-align: left; cursor: pointer; transition: background 0.18s; }
        .language-option:hover, .language-option.active-language { background-color: var(--accent-color); color: white; }
        .language-flag { width: 20px; height: 20px; border-radius: 50%; object-fit: cover; }
        
        /* Upload Area */
        #upload-box {
            border-color: var(--border-color);
            background-color: var(--bg-color);
            transition: all 0.3s;
        }
        #upload-box.dragover {
            border-color: var(--accent-color);
            background-color: #4f46e51a; /* indigo-600 with opacity */
        }
        
        /* File Queue */
        .file-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background-color: transparent;
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            transition: all 0.3s;
        }
        
        .file-icon {
            color: var(--accent-color);
            width: 40px;
            height: 40px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .file-icon svg {
            width: 2rem;
            height: 2rem;
        }

        .file-info { flex-grow: 1; min-width: 0; }
        .file-name { 
            font-weight: 500; 
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .file-size { font-size: 0.875rem; color: var(--text-secondary); }
        .file-status { font-weight: 500; font-size: 0.875rem; }
        .file-status.success { color: var(--success-color); }
        .file-status.error { color: var(--error-color); }
        
        .progress-bar { width: 100%; height: 6px; background-color: var(--border-color); border-radius: 3px; margin-top: 0.5rem; overflow: hidden; }
        .progress-bar-fill { height: 100%; width: 0%; background-color: var(--accent-color); border-radius: 3px; transition: width 0.3s ease-in-out; }

        /* Styles for disabled buttons */
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="font-inter">

    <div class="page-container">
        <div class="content-wrapper">
            <!-- Back to Home & Header -->
            <div class="flex justify-between items-center w-full mb-4">
                <a href="index.html" class="back-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
                    <span data-i18n-key="back-to-home">Back to Home</span>
                </a>
            </div>

            <!-- Main Card -->
            <div class="main-card">
                <header class="flex justify-between items-start gap-4 mb-6">
                    <div>
                        <h1 class="text-2xl font-bold" data-i18n-key="main-heading">Compress Files</h1>
                        <p class="text-base mt-1" style="color: var(--text-secondary);" data-i18n-key="sub-heading">Reduce file size for images, PDFs, and Office docs.</p>
                    </div>
                    <div class="header-controls">
                        <!-- Language Dropdown -->
                        <div class="language-selector" id="lang-dropdown">
                            <button class="language-btn" id="lang-btn" type="button">
                                <img src="https://flagcdn.com/us.svg" class="language-flag" id="lang-flag" alt="English" />
                                <span id="lang-label">English</span>
                                <svg class="arrow w-4 h-4" viewBox="0 0 24 24" fill="none"><path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                            </button>
                            <div class="dropdown-content" id="lang-dropdown-content"></div>
                        </div>
                        <!-- Theme Toggle -->
                        <button class="theme-toggle-btn" id="theme-toggle" title="Toggle dark mode">
                            <svg class="sun-icon w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                            <svg class="moon-icon w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                        </button>
                    </div>
                </header>

                <main class="flex flex-col gap-6">
                    <!-- Upload Module -->
                    <div id="upload-module">
                        <label for="file-input" id="upload-box" class="block cursor-pointer border-2 border-dashed rounded-xl p-8 text-center">
                            <svg class="mx-auto h-12 w-12" style="color: var(--text-muted);" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>
                            <h2 class="mt-4 text-xl font-semibold" data-i18n-key="drop-title">Drag & drop files here</h2>
                            <p class="mt-1 text-sm" style="color: var(--text-secondary);" data-i18n-key="drop-subtitle">or click to select</p>
                            <p class="text-xs mt-4" style="color: var(--text-muted);" data-i18n-key="disclaimer">All processing is done in your browser. Max 100MB.</p>
                        </label>
                        <input type="file" id="file-input" multiple class="hidden">
                    </div>

                    <!-- Processing Queue -->
                    <div id="file-queue" class="flex flex-col gap-4"></div>

                    <!-- Action Buttons -->
                    <div id="action-buttons" class="hidden mt-4 grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <button class="w-full font-semibold py-3 px-4 rounded-lg transition border" style="border-color: var(--border-color); color: var(--text-secondary); background-color: var(--bg-color);" id="clear-all-btn" data-i18n-key="clear-all-btn">Clear All</button>
                        <button class="w-full text-white font-semibold py-3 px-4 rounded-lg transition" style="background-color: var(--accent-color);" onmouseover="this.style.backgroundColor=getComputedStyle(this).getPropertyValue('--accent-hover')" onmouseout="this.style.backgroundColor=getComputedStyle(this).getPropertyValue('--accent-color')" id="add-more-btn" data-i18n-key="add-more-btn">Add More Files</button>
                        <button class="w-full text-white font-semibold py-3 px-4 rounded-lg transition" style="background-color: var(--success-color);" id="download-all-btn" data-i18n-key="download-all-btn">Download All (.zip)</button>
                    </div>
                </main>
            </div>
            
            <footer class="text-center mt-8 py-6 text-sm" style="color: var(--text-muted);">
                <p data-i18n-key="footer-text">© 2024 QuantumCompress. Built for performance and privacy.</p>
            </footer>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    const translations = {
        'en': {
            'back-to-home': 'Back to Home', 'main-heading': 'Compress Files', 'sub-heading': 'Reduce file size for images, PDFs, and Office docs.',
            'drop-title': 'Drag & drop files here', 'drop-subtitle': 'or click to select',
            'disclaimer': 'All processing is done in your browser. Max 100MB.',
            'download-all-btn': 'Download All (.zip)',
            'add-more-btn': 'Add More Files',
            'clear-all-btn': 'Clear All',
            'footer-text': '© 2024 QuantumCompress. Built for performance and privacy.',
            'status-queued': 'Queued', 'status-compressing': 'Compressing...', 'status-complete': 'Complete!',
            'status-error': 'Error', 'status-unsupported': 'Unsupported File Type', 'download-btn': 'Download'
        },
        'km': {
            'back-to-home': 'ត្រឡប់ទៅទំព័រដើម', 'main-heading': 'បង្ហាប់ឯកសារ', 'sub-heading': 'កាត់បន្ថយទំហំឯកសាររូបភាព, PDF, និង Office។',
            'drop-title': 'អូសឯកសារទម្លាក់នៅទីនេះ', 'drop-subtitle': 'ឬចុចដើម្បីជ្រើសរើស',
            'disclaimer': 'ការដំណើរការទាំងអស់គឺនៅក្នុងកម្មវិធីរុករករបស់អ្នក។ អតិបរមា 100MB។',
            'download-all-btn': 'ទាញយកទាំងអស់ (.zip)',
            'add-more-btn': 'បន្ថែមឯកសារ',
            'clear-all-btn': 'លុបទាំងអស់',
            'footer-text': '© 2024 QuantumCompress។ បង្កើតឡើងសម្រាប់ប្រសិទ្ធភាពនិងភាពឯកជន។',
            'status-queued': 'កំពុងរង់ចាំ', 'status-compressing': 'កំពុងបង្ហាប់...', 'status-complete': 'រួចរាល់!',
            'status-error': 'មានបញ្ហា', 'status-unsupported': 'ប្រភេទឯកសារមិនត្រឹមត្រូវ', 'download-btn': 'ទាញយក'
        }
    };
    const langMap = [
        { code: 'en', label: 'English', flag: 'https://flagcdn.com/us.svg', fontClass: '' },
        { code: 'km', label: 'ភាសាខ្មែរ', flag: 'https://flagcdn.com/kh.svg', fontClass: 'font-khmer' }
    ];

    // --- Element Selectors ---
    const uploadBox = document.getElementById('upload-box');
    const fileInput = document.getElementById('file-input');
    const fileQueue = document.getElementById('file-queue');
    const actionButtons = document.getElementById('action-buttons');
    const downloadAllBtn = document.getElementById('download-all-btn');
    const addMoreBtn = document.getElementById('add-more-btn');
    const clearAllBtn = document.getElementById('clear-all-btn');
    const langDropdown = document.getElementById('lang-dropdown');
    const langBtn = document.getElementById('lang-btn');
    const langDropdownContent = document.getElementById('lang-dropdown-content');
    const themeToggle = document.getElementById('theme-toggle');

    let currentLang = 'en';
    let compressedFiles = [];
    let processingCount = 0; // NEW: Track active compression tasks

    // --- Theme Switcher ---
    const applyTheme = (theme) => {
        if (theme === 'dark') {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
        localStorage.setItem('theme', theme);
    };
    themeToggle.addEventListener('click', () => {
        const newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
        applyTheme(newTheme);
    });
    applyTheme(localStorage.getItem('theme') || 'light');


    // --- Language Switcher ---
    const translatePage = () => {
        document.documentElement.lang = currentLang;
        document.body.className = langMap.find(l => l.code === currentLang).fontClass;
        document.querySelectorAll('[data-i18n-key]').forEach(el => {
            const key = el.getAttribute('data-i18n-key');
            if (translations[currentLang]?.[key]) {
                el.innerText = translations[currentLang][key];
            }
        });
        document.querySelectorAll('.dynamic-download-btn span').forEach(span => {
            span.textContent = translations[currentLang]['download-btn'];
        });
    };
    
    const setLang = (langCode) => {
        currentLang = langCode;
        const langData = langMap.find(l => l.code === langCode);
        document.getElementById('lang-flag').src = langData.flag;
        document.getElementById('lang-label').textContent = langData.label;
        langDropdownContent.querySelectorAll('.language-option').forEach(btn => {
            btn.classList.toggle('active-language', btn.dataset.lang === langCode);
        });
        translatePage();
        localStorage.setItem('language', langCode);
    };
    
    langMap.forEach(lang => {
        const option = document.createElement('button');
        option.className = 'language-option';
        if(lang.fontClass) option.classList.add(lang.fontClass);
        option.dataset.lang = lang.code;
        option.innerHTML = `<img src="${lang.flag}" class="language-flag" alt="${lang.label}"/> ${lang.label}`;
        option.onclick = () => { setLang(lang.code); langDropdown.classList.remove('open'); };
        langDropdownContent.appendChild(option);
    });
    
    langBtn.addEventListener('click', (e) => { e.stopPropagation(); langDropdown.classList.toggle('open'); });
    document.addEventListener('click', () => langDropdown.classList.remove('open'));
    setLang(localStorage.getItem('language') || 'en');


    // --- Helper Functions ---
    const formatFileSize = (bytes) => {
        if (bytes === 0) return '0 Bytes';
        const k = 1024, sizes = ['Bytes', 'KB', 'MB', 'GB'], i = Math.floor(Math.log(bytes) / Math.log(k));
        return `${parseFloat((bytes / Math.pow(k, i)).toFixed(2))} ${sizes[i]}`;
    };
    
    // NEW: Helper function to sanitize filenames for download.
    const sanitizeFilename = (name) => {
        // Replaces characters that are invalid in Windows/macOS/Linux filenames.
        return name.replace(/[<>:"/\\|?*]/g, '_');
    };

    // NEW: Function to manage the enabled/disabled state of action buttons.
    const updateActionButtonsState = () => {
        const shouldBeDisabled = processingCount > 0;
        clearAllBtn.disabled = shouldBeDisabled;
        downloadAllBtn.disabled = shouldBeDisabled;
        addMoreBtn.disabled = shouldBeDisabled; // Also disable 'Add More' to avoid queue confusion
    };

    const getFileIcon = (file) => {
        const iconProps = `viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"`;
        const iconImage = `<svg ${iconProps}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>`;
        const iconPdf = `<svg ${iconProps} class="text-red-500"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>`;
        const iconDocx = `<svg ${iconProps} class="text-blue-500"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><line x1="10" y1="9" x2="8" y2="9"></line></svg>`;
        const iconXlsx = `<svg ${iconProps} class="text-green-500"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><line x1="10" y1="9" x2="8" y2="9"></line></svg>`;
        const iconPptx = `<svg ${iconProps} class="text-orange-500"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg>`;
        const iconGeneric = `<svg ${iconProps}><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>`;

        const name = file.name.toLowerCase();
        const type = file.type;
        
        if (type.startsWith('image/')) return iconImage;
        if (type === 'application/pdf') return iconPdf;
        if (name.endsWith('.docx') || name.endsWith('.doc')) return iconDocx;
        if (name.endsWith('.xlsx') || name.endsWith('.xls')) return iconXlsx;
        if (name.endsWith('.pptx') || name.endsWith('.ppt')) return iconPptx;

        return iconGeneric;
    };

    const getExtensionForBlob = (blob) => ({'image/jpeg':'jpg','image/png':'png','application/pdf':'pdf'}[blob.type] || 'bin');

    // --- Compression Logic ---
    const compressImage = (file, onProgress) => new Promise((resolve, reject) => {
        const quality = 0.75; 
        const isPng = file.type === 'image/png';
        const outputType = isPng ? 'image/png' : 'image/jpeg';
        onProgress(0.1);
        const reader = new FileReader();
        reader.onload = e => {
            const img = new Image();
            img.onload = () => {
                onProgress(0.5);
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                onProgress(0.9);
                canvas.toBlob(blob => {
                    onProgress(1);
                    resolve(blob || file); 
                }, outputType, quality);
            };
            img.onerror = () => reject(new Error('Cannot decode image.'));
            img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });

    const compressPDF = async (file, onProgress) => {
        onProgress(0.1);
        const { PDFDocument } = PDFLib;
        const buffer = await file.arrayBuffer();
        onProgress(0.2);
        const pdfDoc = await PDFDocument.load(buffer, { ignoreEncryption: true });

        const images = pdfDoc.getImages();
        if (images.length > 0) {
            await Promise.all(images.map(async (image, i) => {
                try {
                    if (image.isJpg) {
                        const jpgImage = await pdfDoc.embedJpg(await image.embed());
                        image.ref.set(jpgImage.ref.stream);
                    }
                } catch (e) {
                    console.error("Could not re-compress an image in the PDF:", e);
                }
                onProgress(0.2 + (0.7 * ((i + 1) / images.length)));
            }));
        } else {
             onProgress(0.9);
        }
       
        const bytes = await pdfDoc.save();
        onProgress(1);
        return new Blob([bytes], { type: 'application/pdf' });
    };

    const compressOfficeFile = async (file, onProgress) => {
        onProgress(0.2);
        const buffer = await file.arrayBuffer();
        onProgress(0.4);
        const zip = await JSZip.loadAsync(buffer);
        onProgress(0.8);
        return await zip.generateAsync({ type: "blob", compression: "DEFLATE", compressionOptions: { level: 9 } });
    };

    // --- File Handling & UI ---
    uploadBox.addEventListener('click', () => fileInput.click());
    ['dragover', 'dragleave', 'drop'].forEach(ev => uploadBox.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); }));
    uploadBox.addEventListener('dragover', () => uploadBox.classList.add('dragover'));
    uploadBox.addEventListener('dragleave', () => uploadBox.classList.remove('dragover'));
    uploadBox.addEventListener('drop', (e) => {
        uploadBox.classList.remove('dragover');
        if (addMoreBtn.disabled) return;
        handleFiles(e.dataTransfer.files);
    });
    fileInput.addEventListener('change', (e) => {
        handleFiles(e.target.files);
        e.target.value = '';
    });

    const handleFiles = (files) => {
        if (!files.length) return;
        document.getElementById('upload-module').style.display = 'none';
        actionButtons.classList.remove('hidden');
        actionButtons.classList.add('grid');
        [...files].forEach(processFile);
    };

    const processFile = async (file) => {
        processingCount++;
        updateActionButtonsState();

        const fileId = `file-${Date.now()}-${Math.random()}`;
        const fileItem = createQueueItem(file, fileId);
        fileQueue.appendChild(fileItem);
        const progressFill = fileItem.querySelector('.progress-bar-fill');
        const onProgress = p => progressFill.style.width = `${p * 100}%`;

        if (file.size > 100 * 1024 * 1024) {
            updateStatus(fileItem, 'Error: File size exceeds 100MB', 'error');
            processingCount--;
            updateActionButtonsState();
            return;
        }

        try {
            updateStatus(fileItem, translations[currentLang]['status-compressing'], 'progress');
            let compressedBlob;
            const name = file.name.toLowerCase();

            if (file.type.startsWith('image/')) {
                compressedBlob = await compressImage(file, onProgress);
            } else if (file.type === 'application/pdf') {
                compressedBlob = await compressPDF(file, onProgress);
            } else if (name.match(/\.(docx|xlsx|pptx)$/i)) {
                compressedBlob = await compressOfficeFile(file, onProgress);
            } else {
                throw new Error('unsupported');
            }
            onProgress(1);
            
            const ratio = 1 - (compressedBlob.size / file.size);
            const resultText = `✅ ${formatFileSize(compressedBlob.size)} (${Math.round(ratio * 100)}% smaller)`;
            
            updateStatus(fileItem, resultText, 'success');
            addDownloadButton(fileItem, compressedBlob, file.name);
            compressedFiles.push({ blob: compressedBlob, name: file.name });
        } catch (err) {
            console.error("Compression failed for file:", file.name, err);
            if (err.message === 'unsupported') {
                 updateStatus(fileItem, translations[currentLang]['status-unsupported'], 'error');
            } else {
                 updateStatus(fileItem, `${translations[currentLang]['status-error']}`, 'error');
            }
        } finally {
            processingCount--;
            updateActionButtonsState();
        }
    };

    const createQueueItem = (file, fileId) => {
        const item = document.createElement('div');
        item.className = 'file-item';
        item.id = fileId;
        item.innerHTML = `
            <div class="file-icon">${getFileIcon(file)}</div>
            <div class="file-info">
                <div class="file-name" title="${file.name}">${file.name}</div>
                <div class="file-size">${formatFileSize(file.size)} → <span class="file-status">${translations[currentLang]['status-queued']}</span></div>
                <div class="progress-bar"><div class="progress-bar-fill"></div></div>
            </div>
            <div class="file-actions"></div>`;
        return item;
    };

    const updateStatus = (item, text, type) => {
        const statusEl = item.querySelector('.file-status');
        statusEl.innerHTML = text;
        statusEl.className = `file-status ${type}`;
        if (type === 'success' || type === 'error') {
            item.querySelector('.progress-bar').style.display = 'none';
        }
    };

    const addDownloadButton = (item, blob, originalName) => {
        const actionDiv = item.querySelector('.file-actions');
        const sanitizedName = sanitizeFilename(originalName);
        const base = sanitizedName.substring(0, sanitizedName.lastIndexOf('.'));
        const ext = blob.type === "application/octet-stream" ? sanitizedName.split('.').pop() : getExtensionForBlob(blob);
        const dlName = `${base}-compressed.${ext}`;
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = dlName;
        link.className = "dynamic-download-btn inline-flex items-center gap-2 px-3 py-1.5 rounded-md text-sm font-semibold transition";
        link.style.backgroundColor = 'var(--accent-color)';
        link.style.color = 'white';
        link.innerHTML = `
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
            <span>${translations[currentLang]['download-btn']}</span>`;
        actionDiv.appendChild(link);
    };

    downloadAllBtn.addEventListener('click', async () => {
        if (compressedFiles.length === 0 || downloadAllBtn.disabled) return;
        
        const zip = new JSZip();
        compressedFiles.forEach(f => {
            const sanitizedName = sanitizeFilename(f.name);
            const base = sanitizedName.substring(0, sanitizedName.lastIndexOf('.'));
            const ext = f.blob.type === "application/octet-stream" ? sanitizedName.split('.').pop() : getExtensionForBlob(f.blob);
            zip.file(`${base}-compressed.${ext}`, f.blob);
        });

        const zipBlob = await zip.generateAsync({ type: "blob" });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(zipBlob);
        link.download = 'QuantumCompress-files.zip';
        link.click();
        URL.revokeObjectURL(link.href);
    });

    addMoreBtn.addEventListener('click', () => {
        if (addMoreBtn.disabled) return;
        fileInput.click();
    });

    clearAllBtn.addEventListener('click', () => {
        if (clearAllBtn.disabled) return;

        // FIXED: Revoke all created object URLs to prevent memory leaks.
        fileQueue.querySelectorAll('a[download]').forEach(link => {
            if (link.href.startsWith('blob:')) {
                URL.revokeObjectURL(link.href);
            }
        });

        fileQueue.innerHTML = '';
        actionButtons.classList.add('hidden');
        actionButtons.classList.remove('grid');
        document.getElementById('upload-module').style.display = 'block';
        fileInput.value = '';
        compressedFiles = [];
    });
});
</script>
</body>
</html>
